// Dados do jogo
let currentCharacter = {
    race: null,
    blood: null,
    power: null,
    raceDice: null,
    bloodDice: null,
    powerDice: null,
    id: generateCharacterId()
};

let history = [];
let rollCount = 0;

// Elementos DOM
const raceValue = document.getElementById('raceValue');
const bloodValue = document.getElementById('bloodValue');
const powerValue = document.getElementById('powerValue');
const raceDice = document.getElementById('raceDice');
const bloodDice = document.getElementById('bloodDice');
const powerDice = document.getElementById('powerDice');
const characterId = document.getElementById('characterId');
const historyList = document.getElementById('historyList');
const raceBox = document.getElementById('raceBox');
const bloodBox = document.getElementById('bloodBox');
const powerBox = document.getElementById('powerBox');

// Sons (usando Web Audio API)
function playDiceSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 300 + Math.random() * 200;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch (e) {
        console.log("Ãudio nÃ£o suportado ou bloqueado");
    }
}

// Gerar ID Ãºnico
function generateCharacterId() {
    const timestamp = Date.now().toString().slice(-6);
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `LGN-${timestamp}${random}`;
}

// NotificaÃ§Ãµes
function showNotification(message, duration = 3000) {
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');
    
    notificationText.textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, duration);
}

// Efeito visual de rolagem
function animateRoll(element) {
    element.classList.add('loading');
    setTimeout(() => {
        element.classList.remove('loading');
    }, 500);
}

// FunÃ§Ã£o para rolar dado (1-18)
function rollDice() {
    return Math.floor(Math.random() * 18) + 1;
}

// Gerar RaÃ§a
function generateRace() {
    playDiceSound();
    
    const dice = rollDice();
    animateRoll(raceBox);
    
    setTimeout(() => {
        let result;
        
        if (dice >= 1 && dice <= 10) {
            result = "Humano";
        } else if (dice >= 11 && dice <= 14) {
            result = "Gosmento, Ligrimiano ou LÃ¡ Douriano (Escolha)";
        } else {
            result = "Semi-deus ou Arcanjo (Escolha)";
        }
        
        currentCharacter.race = result;
        currentCharacter.raceDice = dice;
        
        raceValue.textContent = result;
        raceDice.textContent = `Dado: ${dice}`;
        raceBox.classList.add('active');
        
        addToHistory(`ðŸŽ² RaÃ§a sorteada: ${result} (${dice}/18)`);
        rollCount++;
        
        showNotification(`ðŸŽ­ RaÃ§a determinada: ${result.split(' ')[0]}`);
    }, 500);
}

// Gerar Linhagem SanguÃ­nea
function generateBlood() {
    playDiceSound();
    
    const dice = rollDice();
    animateRoll(bloodBox);
    
    setTimeout(() => {
        let result;
        
        if (dice >= 1 && dice <= 10) {
            result = "Plebeu";
        } else if (dice >= 11 && dice <= 16) {
            result = "Real";
        } else {
            result = "Descendente do 'PAI'";
        }
        
        currentCharacter.blood = result;
        currentCharacter.bloodDice = dice;
        
        bloodValue.textContent = result;
        bloodDice.textContent = `Dado: ${dice}`;
        bloodBox.classList.add('active');
        
        addToHistory(`ðŸ’‰ Linhagem sorteada: ${result} (${dice}/18)`);
        rollCount++;
        
        showNotification(`ðŸ©¸ Linhagem: ${result}`);
    }, 500);
}

// Gerar Poder
function generatePower() {
    playDiceSound();
    
    const dice = rollDice();
    animateRoll(powerBox);
    
    setTimeout(() => {
        let result;
        
        if (dice >= 1 && dice <= 10) {
            result = "Elemental";
        } else if (dice >= 11 && dice <= 15) {
            result = "Elemental + Subelemento";
        } else {
            result = "Magia Arcana (Tempo/Portal/Trevas/Luz/AdaptaÃ§Ã£o/CÃ³pia)";
        }
        
        currentCharacter.power = result;
        currentCharacter.powerDice = dice;
        
        powerValue.textContent = result;
        powerDice.textContent = `Dado: ${dice}`;
        powerBox.classList.add('active');
        
        addToHistory(`ðŸ”® Poder sorteado: ${result.split(' ')[0]} (${dice}/18)`);
        rollCount++;
        
        showNotification(`âœ¨ Poder: ${result.split(' ')[0]}`);
    }, 500);
}

// Gerar tudo de uma vez
function generateAll() {
    playDiceSound();
    
    // Animar todos os elementos
    animateRoll(raceBox);
    animateRoll(bloodBox);
    animateRoll(powerBox);
    
    // Desabilitar botÃµes durante a animaÃ§Ã£o
    disableButtons(true);
    
    setTimeout(() => {
        // Gerar todos os valores
        generateRace();
        setTimeout(() => {
            generateBlood();
            setTimeout(() => {
                generatePower();
                
                // Atualizar ID
                currentCharacter.id = generateCharacterId();
                characterId.textContent = `ID: ${currentCharacter.id}`;
                
                // Reabilitar botÃµes
                disableButtons(false);
                
                showNotification(`ðŸŽ­ Personagem completo criado! ID: ${currentCharacter.id}`);
                addToHistory(`ðŸŒŸ PERSONAGEM COMPLETO CRIADO - ${currentCharacter.id}`);
            }, 600);
        }, 600);
    }, 600);
}

// Desabilitar/Habilitar botÃµes
function disableButtons(disable) {
    const buttons = document.querySelectorAll('.stat-btn, .control-btn');
    buttons.forEach(btn => {
        btn.disabled = disable;
        btn.style.opacity = disable ? '0.5' : '1';
        btn.style.cursor = disable ? 'not-allowed' : 'pointer';
    });
}

// Adicionar ao histÃ³rico
function addToHistory(text) {
    const timestamp = new Date().toLocaleTimeString();
    const historyItem = document.createElement('div');
    historyItem.className = 'history-item';
    historyItem.innerHTML = `<strong>${timestamp}</strong> - ${text}`;
    
    historyList.prepend(historyItem);
    history.unshift({ text, timestamp });
    
    // Limitar histÃ³rico a 10 itens
    if (historyList.children.length > 10) {
        historyList.removeChild(historyList.lastChild);
        history.pop();
    }
}

// Salvar personagem
function saveCharacter() {
    if (!currentCharacter.race || !currentCharacter.blood || !currentCharacter.power) {
        showNotification('âš ï¸ Complete o personagem antes de salvar!', 4000);
        return;
    }
    
    const characterData = {
        ...currentCharacter,
        savedAt: new Date().toISOString(),
        rollCount: rollCount
    };
    
    // Salvar no localStorage
    let savedCharacters = JSON.parse(localStorage.getItem('legionariosCharacters') || '[]');
    savedCharacters.push(characterData);
    localStorage.setItem('legionariosCharacters', JSON.stringify(savedCharacters));
    
    // Criar texto para download
    const text = `LEGIONÃRIOS - FICHA DE PERSONAGEM
=========================================
ID: ${currentCharacter.id}
Data: ${new Date().toLocaleString()}

ðŸ›ï¸ RAÃ‡A: ${currentCharacter.race} (Dado: ${currentCharacter.raceDice})
ðŸ’‰ LINHAGEM: ${currentCharacter.blood} (Dado: ${currentCharacter.bloodDice})
ðŸ”® PODER: ${currentCharacter.power} (Dado: ${currentCharacter.powerDice})

Total de rolagens: ${rollCount}
=========================================
Gerado pelo Sistema LegionÃ¡rios âš”ï¸`;

    // Download do arquivo
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `legionarios_${currentCharacter.id}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('ðŸ’¾ Personagem salvo com sucesso!');
}

// Compartilhar personagem
function shareCharacter() {
    if (!currentCharacter.race || !currentCharacter.blood || !currentCharacter.power) {
        showNotification('Crie um personagem primeiro!');
        return;
    }
    
    const shareText = `ðŸŽ­ Meu personagem LegionÃ¡rios:
ID: ${currentCharacter.id}
RaÃ§a: ${currentCharacter.race}
Linhagem: ${currentCharacter.blood}
Poder: ${currentCharacter.power}

Crie o seu em: ${window.location.href}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Meu Personagem LegionÃ¡rios',
            text: shareText,
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(shareText).then(() => {
            showNotification('ðŸ“‹ Link copiado para a Ã¡rea de transferÃªncia!');
        });
    }
}

// Copiar ficha
function copyCharacter() {
    if (!currentCharacter.race || !currentCharacter.blood || !currentCharacter.power) {
        showNotification('Crie um personagem primeiro!');
        return;
    }
    
    const text = `LEGIONÃRIOS - ${currentCharacter.id}
RaÃ§a: ${currentCharacter.race}
Linhagem: ${currentCharacter.blood}
Poder: ${currentCharacter.power}`;
    
    navigator.clipboard.writeText(text).then(() => {
        showNotification('ðŸ“‹ Ficha copiada!');
    });
}

// Reiniciar tudo
function resetAll() {
    if (confirm('Tem certeza que deseja reiniciar tudo?')) {
        currentCharacter = {
            race: null,
            blood: null,
            power: null,
            raceDice: null,
            bloodDice: null,
            powerDice: null,
            id: generateCharacterId()
        };
        
        raceValue.textContent = 'Aguardando sorteio...';
        bloodValue.textContent = 'Aguardando sorteio...';
        powerValue.textContent = 'Aguardando sorteio...';
        
        raceDice.textContent = 'Dado: -';
        bloodDice.textContent = 'Dado: -';
        powerDice.textContent = 'Dado: -';
        
        characterId.textContent = `ID: ${currentCharacter.id}`;
        
        raceBox.classList.remove('active');
        bloodBox.classList.remove('active');
        powerBox.classList.remove('active');
        
        historyList.innerHTML = '';
        history = [];
        rollCount = 0;
        
        showNotification('ðŸ”„ Tudo reiniciado!');
    }
}

// Atalhos de teclado
document.addEventListener('keydown', (e) => {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key.toLowerCase()) {
            case '1':
                e.preventDefault();
                generateRace();
                break;
            case '2':
                e.preventDefault();
                generateBlood();
                break;
            case '3':
                e.preventDefault();
                generatePower();
                break;
            case 'a':
                e.preventDefault();
                generateAll();
                break;
            case 's':
                e.preventDefault();
                saveCharacter();
                break;
            case 'r':
                e.preventDefault();
                resetAll();
                break;
        }
    }
    
    // Tecla espaÃ§o para gerar tudo
    if (e.code === 'Space' && e.target === document.body) {
        e.preventDefault();
        generateAll();
    }
});

// InicializaÃ§Ã£o
document.addEventListener('DOMContentLoaded', () => {
    characterId.textContent = `ID: ${currentCharacter.id}`;
    
    // Adicionar instruÃ§Ã£o inicial ao histÃ³rico
    addToHistory('ðŸš€ Sistema LegionÃ¡rios iniciado. Comece a criar!');
    
    // Mostrar dicas
    setTimeout(() => {
        showNotification('âœ¨ Dica: Use Ctrl+1, Ctrl+2, Ctrl+3 para sortear rapidamente!');
    }, 2000);
});

// Suporte offline
window.addEventListener('online', () => {
    showNotification('ðŸŒ Conectado Ã  internet');
});

window.addEventListener('offline', () => {
    showNotification('ðŸ“´ Modo offline ativado - tudo funcionando!');
});

// Instalar como PWA (Progressive Web App)
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(error => {
            console.log('Service Worker falhou:', error);
        });
    });
}

// Instalar prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    setTimeout(() => {
        if (confirm('Deseja instalar o Gerador LegionÃ¡rios no seu celular para acesso rÃ¡pido?')) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    showNotification('ðŸ“± App instalado com sucesso!');
                }
                deferredPrompt = null;
            });
        }
    }, 10000);
});
